import streamlit as st
import re

# 문항 정의 (질문: 한국어 / 출력: 영어)
questions = [
    {"id": 1, "ko": "사람과의 관계", "en": "1. Relationship to People"},
    {"id": 2, "ko": "모방", "en": "2. Imitation"},
    {"id": 3, "ko": "정서 반응", "en": "3. Emotional Response"},
    {"id": 4, "ko": "신체 사용", "en": "4. Body Use"},
    {"id": 5, "ko": "물체 사용", "en": "5. Object Use"},
    {"id": 6, "ko": "변화에의 적응", "en": "6. Adaptation to Change"},
    {"id": 7, "ko": "시각 반응", "en": "7. Visual Response"},
    {"id": 8, "ko": "청각 반응", "en": "8. Listening Response"},
    {"id": 9, "ko": "미각, 후각, 촉각 반응 및 사용", "en": "9. Taste, Smell, and Touch Response and Use"},
    {"id": 10, "ko": "두려움, 신경과민", "en": "10. Fear or Nervousness"},
    {"id": 11, "ko": "언어적 의사소통", "en": "11. Verbal Communication"},
    {"id": 12, "ko": "비언어적 의사소통", "en": "12. Nonverbal Communication"},
    {"id": 13, "ko": "활동 수준", "en": "13. Activity Level"},
    {"id": 14, "ko": "지적기능의 수준과 향상성", "en": "14. Level and Consistency of Intellectual Response"},
    {"id": 15, "ko": "부모가 주관적으로 느끼는 자녀의 인상", "en": "15. General Impressions"}
]

# 문항별 선택지
options = {
    1: [
        "연령에 적절하게 수줍어하는 성격이거나, 산만하게 활동적인 성격이다. (1)",
        "어른과 눈맞춤이 적다. 눈맞춤을 강요하면 도망가기도 한다. (2)",
        "주변을 의식하지 못하는 듯 혼자 논다. 아동의 주의를 끌기 위해서 노력해야 한다. (3)",
        "아동의 주의를 끌기 위해 노력해도 거의 주의를 끌기 어렵다. 자발적 접촉이 거의 없다. (4)"
    ],
    2: [
        "연령에 적절하게 언어와 행동을 모방한다. (1)",
        "박수나 한음절 소리 등 매우 간단한 것만을 모방한다. (2)",
        "간단한 것이라도 모방을 하기도 하고 안 하기도 한다. 얼마 후에 모방하는 경향이 있다. (3)",
        "모방은 전혀 없다. (4)"
    ],
    3: [
        "기뻐하고 슬퍼하고 놀라고 무서워하는 등 정서 반응을 상황에 적절하게 나타낸다. (1)",
        "가끔씩 상황과 관계없는 정서 반응을 보인다. (2)",
        "정서 반응이 다양하지 않으며, 상황과 무관한 정서 반응을 자주 보인다. (3)",
        "거의 대부분의 정서 반응이 상황과 부적절하다. 알 수 없는 이유로 우울해 하거나 즐거워한다. (4)"
    ],
    4: [
        "몸 움직임이 안정적이며 민첩하다. (1)",
        "둔하고 반복적인 움직임이 있다. (2)",
        "몸 흔들기, 빙빙 돌기, 손가락 흔들기, 까치발 들기 등 이상한 행동을 한다. (3)",
        "3번에서 제시한 이상한 행동이 매우 심해 그만두게 하기가 힘들다. (4)"
    ],
    5: [
        "다양한 장난감을 가지고 논다. (1)",
        "장난감에 대한 관심이 적고, 용도와 무관하게(들고 다니거나 빨기 등) 논다. (2)",
        "장난감에 거의 관심이 없고, 일부분에만 관심을 보인다. (3)",
        "3번에서 제시한 행동이 매우 심해서 그만두게 하기가 힘들다. (4)"
    ],
    6: [
        "일상적인 생활에 변화가 와도 잘 받아들인다. (1)",
        "변화에 거부감을 보이며 똑같은 것만 고집한다. (2)",
        "변화에 대한 거부가 심해 화를 내거나 참지 못한다. (3)",
        "변화에 대한 거부가 극심해 떼를 쓰고 달랠 수 없다. (4)"
    ],
    7: [
        "시각 사용에 이상이 없다. (1)",
        "거울이나 빛을 좋아하며 허공을 응시하기도 한다. (2)",
        "이상한 각도로 보거나 눈 가까이에 대고 본다. (3)",
        "3번과 같은 행동을 대부분의 시간 동안 한다. (4)"
    ],
    8: [
        "청각 사용에 이상이 없다. (1)",
        "소리에 반응이 느리며 여러 번 불러야 반응한다. (2)",
        "큰 소리에도 반응 없거나 익숙한 소리에 놀란다. (3)",
        "2번, 3번과 같은 반응이 극단적으로 나타난다. (4)"
    ],
    9: [
        "미각, 후각, 촉각에 이상이 없다. (1)",
        "물체를 입에 넣거나 먹지 않는 물건을 맛보려 한다. (2)",
        "사람이나 물체를 맛보거나 냄새 맡는 데 많은 시간을 쓴다. (3)",
        "위 행동을 대부분의 시간에 하며 아픔에도 거의 반응하지 않는다. (4)"
    ],
    10: [
        "적절한 상황에서만 두려움이나 불안을 보인다. (1)",
        "적절한 상황에서도 지나친 두려움과 불안을 보인다. (2)",
        "부적절한 상황에서 두려움, 불안 반응을 자주 보인다. (3)",
        "전혀 두렵지 않은 물체에도 두려움을 보이거나, 두려워할 대상에는 무반응이다. (4)"
    ],
    11: [
        "연령에 적절한 언어 발달을 보인다. (1)",
        "언어 발달이 늦고 반향어, 반복 표현을 보인다. (2)",
        "말이 없거나 의미 없는 말, 중얼거림이 많다. (3)",
        "의미 있는 언어 사용이 없고 동물 같은 소리를 낸다. (4)"
    ],
    12: [
        "비언어적 표현을 잘 사용한다. (1)",
        "끌고 가기, 가리키기 등의 유아 수준 표현을 사용한다. (2)",
        "비언어적 요구를 하지 않으며 타인의 표현도 이해하지 못한다. (3)",
        "이상한 몸짓 외에는 표현이 없고 표정도 없다. (4)"
    ],
    13: [
        "활동 수준이 적절하다. (1)",
        "약간 안절부절하거나 느리다. (2)",
        "과잉 활동적이거나 무기력하다. (3)",
        "과잉과 무기력을 반복하거나 매우 심하다. (4)"
    ],
    14: [
        "인지 능력에 특별한 문제가 없다. (1)",
        "전반적으로 지체되어 있다. (2)",
        "대체로 지체되었으나 특정 영역은 정상이다. (3)",
        "대체로 지체되었으나 특정 영역은 매우 우수하다. (4)"
    ],
    15: [
        "자폐 증상이 없다. (1)",
        "경미한 자폐 증상이 있다. (2)",
        "중간 정도의 자폐 증상이 있다. (3)",
        "심한 자폐 증상이 있다. (4)"
    ]
}

st.title("CARS (Childhood Autism Rating Scale)")

user_inputs = []
all_answered = True

for q in questions:
    choice = st.selectbox(q["ko"], options[q["id"]], key=q["id"])
    if not choice:
        all_answered = False
    user_inputs.append(f'{q["en"]} {choice}')

if st.button("Show Result"):
    if not all_answered or len(user_inputs) != 15:
        st.warning("모든 15개 문항에 응답해 주세요.")
    else:
        # 점수 추출 (첫 괄호 안 숫자만)
        scores = [float(re.search(r"\((\d+)\)", s).group(1)) for s in user_inputs]
        total_score = sum(scores)

        # 임상적 해석
        if total_score < 30:
            interpretation = "No autism (within normal range)"
        elif 30 <= total_score <= 36.5:
            interpretation = "Mild to moderate autism"
        else:
            interpretation = "Severe autism"

        output = ["CARS", ""]
        output.extend(user_inputs)
        output.append("")
        output.append(f"총점: {total_score}")
        output.append(f"임상적 해석: {interpretation}")

        final_output = "\n".join(output)
        st.code(final_output, language="markdown")
